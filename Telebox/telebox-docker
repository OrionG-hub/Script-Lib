#!/usr/bin/env bash

# TeleBox Docker Compose 一键安装脚本（使用预构建镜像）
# Version: 2.2.2

if [[ $EUID -ne 0 ]]; then
    echo "错误：本脚本需要 root 权限执行。" 1>&2
    exit 1
fi

# Docker Compose 兼容函数
docker_compose_wrapper() {
    if command -v docker-compose >> /dev/null 2>&1; then
        docker-compose "$@"
    elif docker compose version >> /dev/null 2>&1; then
        docker compose "$@"
    else
        echo "错误：Docker Compose 未安装"
        echo "请运行: apt-get install docker-compose-plugin 或 yum install docker-compose-plugin"
        exit 1
    fi
}

welcome() {
    echo
    echo "TeleBox Docker Compose 安装即将开始"
    echo "如果您想取消安装，"
    echo "请在 5 秒钟内按 Ctrl+C 终止此脚本。"
    echo
    sleep 5
}

validate_container_name() {
    local name=$1
    # 检查是否只包含字母和数字
    if [[ ! "$name" =~ ^[a-zA-Z0-9]+$ ]]; then
        return 1
    fi
    return 0
}

check_telebox_image() {
    local image_name="telebox:latest"

    echo "正在检查 TeleBox 镜像是否存在..."

    if docker images --format "{{.Repository}}:{{.Tag}}" | grep -q "^telebox:latest$"; then
        echo "TeleBox 镜像已存在，使用现有镜像。"
        return 0
    else
        echo "TeleBox 镜像不存在，正在构建本地镜像..."
        build_telebox_image
        return 0
    fi
}

build_telebox_image() {
    echo "开始构建 TeleBox 镜像..."

    # 创建临时目录和 Dockerfile
    temp_build_dir="/tmp/telebox-build-$(date +%s)"
    mkdir -p "$temp_build_dir"

    # 创建 Dockerfile
    cat > "$temp_build_dir/Dockerfile" << 'EOF'
FROM debian:12

# 安装必要的依赖
RUN apt-get update && \
    apt-get install -y curl ca-certificates gnupg sudo && \
    update-ca-certificates && \
    curl -fsSL https://deb.nodesource.com/setup_20.x | bash - && \
    apt-get install -y nodejs && \
    npm i -g pm2 && \
    rm -rf /var/lib/apt/lists/*

# 设置工作目录
WORKDIR /root

# 默认命令 - 安装 TeleBox（如果不存在）并启动
CMD ["bash", "-c", "set -e; \
    if [ ! -d '/root/telebox' ]; then \
        curl -fsSL https://raw.githubusercontent.com/OrionG-hub/Script-Lib/refs/heads/master/Telebox/installTeleBox.sh -o /root/installTeleBox.sh && \
        chmod +x /root/installTeleBox.sh && \
        /root/installTeleBox.sh && \
        rm /root/installTeleBox.sh; \
    fi; \
    exec pm2-runtime /root/telebox/ecosystem.config.js"]
EOF

    # 构建镜像
    if docker build -t telebox:latest "$temp_build_dir"; then
        echo "TeleBox 镜像构建成功！"
        # 清理临时目录
        rm -rf "$temp_build_dir"
        return 0
    else
        echo "镜像构建失败，清理临时文件..."
        rm -rf "$temp_build_dir"
        return 1
    fi
}

list_telebox_containers() {
    echo
    echo "=========================================="
    echo "  当前系统中的 TeleBox 容器"
    echo "=========================================="

    # 查找所有容器（包括停止的）
    containers=$(docker ps -a --format "{{.Names}}" 2>/dev/null)

    if [ -z "$containers" ]; then
        echo "未找到任何容器"
    else
        echo
        echo "容器名称          状态"
        echo "----------------------------------------"
        while IFS= read -r container; do
            status=$(docker inspect -f '{{.State.Status}}' "$container" 2>/dev/null)
            case $status in
                running)
                    status_cn="运行中"
                    ;;
                exited)
                    status_cn="已停止"
                    ;;
                paused)
                    status_cn="已暂停"
                    ;;
                restarting)
                    status_cn="重启中"
                    ;;
                *)
                    status_cn="$status"
                    ;;
            esac
            printf "%-16s  %s\n" "$container" "$status_cn"
        done <<< "$containers"
    fi
    echo "=========================================="
    echo
}

docker_check() {
    echo "正在检查 Docker 安装情况 . . ."
    if command -v docker >> /dev/null 2>&1; then
        echo "Docker 已安装，安装过程继续 . . ."
    else
        echo "Docker 未安装在此系统上"
        printf "是否现在安装 Docker? [Y/n]: "
        read -r install_docker <&1
        case $install_docker in
            [nN][oO] | [nN])
                echo "用户选择不安装 Docker，退出脚本。"
                exit 0
                ;;
            *)
                echo "开始安装 Docker . . ."
                install_docker_package
                ;;
        esac
    fi

    # 检查 Docker Compose 插件
    if command -v docker-compose >> /dev/null 2>&1; then
        echo "Docker Compose v1 已安装"
    elif docker compose version >> /dev/null 2>&1; then
        echo "Docker Compose Plugin 已安装"
    else
        echo "警告：Docker Compose 未安装，将使用 docker compose 子命令"
    fi
}

install_docker_package() {
    if [ -f /etc/os-release ]; then
        . /etc/os-release
        OS=$ID
    else
        echo "无法检测操作系统类型"
        exit 1
    fi

    case $OS in
        ubuntu | debian)
            echo "检测到 Ubuntu/Debian 系统，开始安装 Docker..."
            apt-get update
            apt-get install -y ca-certificates curl gnupg lsb-release
            mkdir -p /etc/apt/keyrings
            curl -fsSL https://download.docker.com/linux/$OS/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/$OS $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
            apt-get update
            apt-get install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin
            ;;
        centos | rhel | fedora)
            echo "检测到 CentOS/RHEL/Fedora 系统，开始安装 Docker..."
            yum install -y yum-utils
            yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
            yum install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin
            systemctl start docker
            systemctl enable docker
            ;;
        *)
            echo "不支持的操作系统: $OS"
            echo "请手动安装 Docker 后重新运行此脚本"
            exit 1
            ;;
    esac

    if command -v docker >> /dev/null 2>&1; then
        echo "Docker 安装成功！"
    else
        echo "Docker 安装失败，请手动安装"
        exit 1
    fi
}

access_check() {
    echo "测试 Docker 环境 . . ."
    if [ -w /var/run/docker.sock ]; then
        echo "该用户可以使用 Docker，安装过程继续 . . ."
    else
        echo "该用户无权访问 Docker，或者 Docker 没有运行。"
        echo "尝试启动 Docker 服务 . . ."
        systemctl start docker 2>/dev/null || service docker start 2>/dev/null
        sleep 2
        if [ -w /var/run/docker.sock ]; then
            echo "Docker 服务已启动"
        else
            echo "请添加自己到 Docker 组并重新运行此脚本。"
            echo "运行命令: usermod -aG docker $USER"
            exit 1
        fi
    fi
}

get_telegram_config() {
    echo
    echo "=========================================="
    echo "请输入 Telegram 配置信息"
    echo "=========================================="
    echo

    printf "请输入您的 Telegram API ID: "
    read -r api_id <&1

    printf "请输入您的 Telegram API Hash: "
    read -r api_hash <&1

    if [ -z "$api_id" ] || [ -z "$api_hash" ]; then
        echo "错误：API ID 和 API Hash 不能为空"
        exit 1
    fi

    echo
    echo "配置信息已保存"
    echo "API ID: $api_id"
    echo "API Hash: $api_hash"
    echo
}

build_compose_env() {
    while true; do
        printf "请输入 TeleBox 容器的名称（仅限字母和数字）[默认: telebox]: "
        read -r container_name <&1

        if [ -z "$container_name" ]; then
            container_name="telebox"
            break
        fi

        if validate_container_name "$container_name"; then
            break
        else
            echo "错误：容器名称只能包含字母和数字，请重新输入"
            echo
        fi
    done

    echo "容器名称: $container_name"

    # 创建宿主机数据目录
    data_dir="/root/Docker_Telebox/$container_name"
    mkdir -p "$data_dir"

    # 创建临时目录存储 compose 文件
    temp_dir="/tmp/telebox-compose-$container_name"
    mkdir -p "$temp_dir"

    # 创建 .env 文件
    cat > "$temp_dir/.env" << EOF
CONTAINER_NAME=$container_name
API_ID=$api_id
API_HASH=$api_hash
EOF

    # 创建 docker-compose.yml 文件（使用预构建镜像）
    cat > "$temp_dir/docker-compose.yml" << EOF
version: '3.8'

services:
  telebox:
    image: telebox:latest
    container_name: \${CONTAINER_NAME:-telebox}
    restart: unless-stopped
    volumes:
      - "/root/Docker_Telebox/\${CONTAINER_NAME:-telebox}:/root"
    pull_policy: never  # 不从远程拉取镜像
    environment:
      - API_ID=\${API_ID}
      - API_HASH=\${API_HASH}
EOF

    echo "数据目录: $data_dir"
    echo "Compose 文件目录: $temp_dir"
    echo "正在准备 Docker 环境 . . ."

    # 停止并删除现有容器（如果存在）
    if docker ps -a --format "{{.Names}}" | grep -q "^$container_name$"; then
        echo "检测到同名容器，正在停止并删除 . . ."
        docker_compose_wrapper -f "$temp_dir/docker-compose.yml" down --remove-orphans > /dev/null 2>&1
    fi
}

start_compose_interactive() {
    echo
    echo "=========================================="
    echo "第一阶段：交互式安装 TeleBox"
    echo "=========================================="
    echo
    echo "正在启动容器进行配置 . . ."
    echo "请注意：接下来需要您登录 Telegram 账号"
    echo
    sleep 3

    # 获取当前 compose 文件目录
    temp_dir="/tmp/telebox-compose-$container_name"

    # 第一步：交互式安装
    docker_compose_wrapper -f "$temp_dir/docker-compose.yml" run --rm --name "$container_name" telebox bash -lc "set -e; \
        echo '欢迎使用 TeleBox 安装向导'; \
        echo '请按照提示完成 Telegram 账号配置'; \
        echo '如果 TeleBox 未安装，将自动安装...'; \
        if [ ! -d '/root/telebox' ]; then \
            curl -fsSL https://github.com/EAlyce/conf/raw/refs/heads/main/Linux/installTeleBox.sh -o /root/installTeleBox.sh; \
            chmod +x /root/installTeleBox.sh; \
            /root/installTeleBox.sh; \
            rm /root/installTeleBox.sh; \
        fi; \
        echo ''; \
        echo '安装完成，正在保存 PM2 配置...'; \
        pm2 ls; \
        pm2 save; \
        echo ''; \
        echo '按 Ctrl+C 继续下一步...'"
}

start_compose_daemon() {
    echo
    echo "=========================================="
    echo "第二阶段：启动后台服务"
    echo "=========================================="
    echo

    # 获取当前 compose 文件目录
    temp_dir="/tmp/telebox-compose-$container_name"

    # 启动服务
    echo "正在以后台模式启动 TeleBox . . ."
    docker_compose_wrapper -f "$temp_dir/docker-compose.yml" up -d

    echo
    echo "=========================================="
    echo "TeleBox 安装完成！"
    echo "=========================================="
    echo
    echo "容器名称: $container_name"
    echo "数据目录: /root/Docker_Telebox/$container_name"
    echo
    echo "TeleBox 文件位置："
    echo "  宿主机: /root/Docker_Telebox/$container_name/telebox"
    echo "  容器内: /root/telebox"
    echo
    echo "常用命令："
    echo "  查看日志: docker_compose_wrapper -f $temp_dir/docker-compose.yml logs -f"
    echo "  进入容器: docker_compose_wrapper -f $temp_dir/docker-compose.yml exec telebox bash"
    echo "  重启服务: docker_compose_wrapper -f $temp_dir/docker-compose.yml restart"
    echo "  停止服务: docker_compose_wrapper -f $temp_dir/docker-compose.yml down"
    echo "  查看文件: ls -la /root/Docker_Telebox/$container_name/telebox"
    echo
}

start_installation() {
    get_telegram_config  # 先获取配置
    welcome
    docker_check
    access_check
    check_telebox_image  # 检查或构建 TeleBox 镜像
    build_compose_env
    start_compose_interactive
    start_compose_daemon
}

cleanup() {
    list_telebox_containers

    while true; do
        printf "请输入要卸载的 TeleBox 容器名称（仅限字母和数字）[默认: telebox]: "
        read -r container_name <&1

        if [ -z "$container_name" ]; then
            container_name="telebox"
            break
        fi

        if validate_container_name "$container_name"; then
            break
        else
            echo "错误：容器名称只能包含字母和数字，请重新输入"
            echo
        fi
    done

    echo "开始卸载 TeleBox . . ."

    # 尝试查找 compose 目录
    temp_dir="/tmp/telebox-compose-$container_name"

    if [ -f "$temp_dir/docker-compose.yml" ]; then
        # 使用 docker-compose 停止并删除容器
        docker_compose_wrapper -f "$temp_dir/docker-compose.yml" down --remove-orphans > /dev/null 2>&1
    elif docker inspect "$container_name" &>/dev/null; then
        # 如果 compose 文件不存在，则直接删除容器
        docker rm -f "$container_name" &>/dev/null
    fi

    echo "容器 $container_name 已删除"

    data_dir="/root/Docker_Telebox/$container_name"
    if [ -d "$data_dir" ]; then
        printf "是否删除数据目录 $data_dir? 这将删除所有数据 [y/N]: "
        read -r remove_data <&1
        case $remove_data in
            [yY][eE][sS] | [yY])
                rm -rf "$data_dir"
                echo "数据目录已删除"
                ;;
            *)
                echo "数据目录已保留在: $data_dir"
                ;;
        esac
    fi

    # 清理 compose 临时文件
    if [ -d "$temp_dir" ]; then
        rm -rf "$temp_dir"
        echo "Compose 配置文件已清理"
    fi

    echo
    echo "=========================================="
    echo "TeleBox 卸载完成！"
    echo "=========================================="
    echo
    exit 0
}

stop_telebox() {
    list_telebox_containers

    while true; do
        printf "请输入要关闭的 TeleBox 容器名称（仅限字母和数字）[默认: telebox]: "
        read -r container_name <&1

        if [ -z "$container_name" ]; then
            container_name="telebox"
            break
        fi

        if validate_container_name "$container_name"; then
            break
        else
            echo "错误：容器名称只能包含字母和数字，请重新输入"
            echo
        fi
    done

    # 查找 compose 目录
    temp_dir="/tmp/telebox-compose-$container_name"
    if [ ! -f "$temp_dir/docker-compose.yml" ]; then
        # 如果没有找到 compose 文件，尝试使用 docker 命令
        if docker inspect "$container_name" &>/dev/null; then
            docker stop "$container_name" &>/dev/null
            echo
            echo "TeleBox 已关闭"
            echo
        else
            echo "不存在名为 $container_name 的容器"
            exit 1
        fi
    else
        # 使用 docker-compose 停止服务
        docker_compose_wrapper -f "$temp_dir/docker-compose.yml" down > /dev/null 2>&1
        echo
        echo "TeleBox 已关闭"
        echo
    fi

    show_menu
}

start_telebox() {
    list_telebox_containers

    while true; do
        printf "请输入要启动的 TeleBox 容器名称（仅限字母和数字）[默认: telebox]: "
        read -r container_name <&1

        if [ -z "$container_name" ]; then
            container_name="telebox"
            break
        fi

        if validate_container_name "$container_name"; then
            break
        else
            echo "错误：容器名称只能包含字母和数字，请重新输入"
            echo
        fi
    done

    # 查找 compose 目录
    temp_dir="/tmp/telebox-compose-$container_name"
    if [ ! -f "$temp_dir/docker-compose.yml" ]; then
        echo "错误：找不到 Compose 配置文件，无法启动服务"
        exit 1
    fi

    echo "正在启动 TeleBox 容器 . . ."

    # 使用 docker-compose 启动服务
    docker_compose_wrapper -f "$temp_dir/docker-compose.yml" up -d > /dev/null 2>&1

    echo
    echo "TeleBox 启动完成"
    echo

    show_menu
}

restart_telebox() {
    list_telebox_containers

    while true; do
        printf "请输入要重启的 TeleBox 容器名称（仅限字母和数字）[默认: telebox]: "
        read -r container_name <&1

        if [ -z "$container_name" ]; then
            container_name="telebox"
            break
        fi

        if validate_container_name "$container_name"; then
            break
        else
            echo "错误：容器名称只能包含字母和数字，请重新输入"
            echo
        fi
    done

    # 查找 compose 目录
    temp_dir="/tmp/telebox-compose-$container_name"
    if [ ! -f "$temp_dir/docker-compose.yml" ]; then
        echo "错误：找不到 Compose 配置文件，无法重启服务"
        exit 1
    fi

    echo "正在重启 TeleBox 容器 . . ."

    # 使用 docker-compose 重启服务
    docker_compose_wrapper -f "$temp_dir/docker-compose.yml" restart > /dev/null 2>&1

    echo
    echo "TeleBox 重启完成"
    echo

    show_menu
}

reinstall_telebox() {
    list_telebox_containers

    while true; do
        printf "请输入要重装的 TeleBox 容器名称（仅限字母和数字）[默认: telebox]: "
        read -r container_name <&1

        if [ -z "$container_name" ]; then
            container_name="telebox"
            break
        fi

        if validate_container_name "$container_name"; then
            break
        else
            echo "错误：容器名称只能包含字母和数字，请重新输入"
            echo
        fi
    done

    echo "开始重装 TeleBox . . ."
    echo

    printf "是否保留原有数据? [Y/n]: "
    read -r keep_data <&1

    # 停止并删除现有容器
    temp_dir="/tmp/telebox-compose-$container_name"
    if [ -f "$temp_dir/docker-compose.yml" ]; then
        docker_compose_wrapper -f "$temp_dir/docker-compose.yml" down --remove-orphans > /dev/null 2>&1
    elif docker inspect "$container_name" &>/dev/null; then
        docker rm -f "$container_name" &>/dev/null
    fi

    echo "旧容器已删除"

    data_dir="/root/Docker_Telebox/$container_name"
    case $keep_data in
        [nN][oO] | [nN])
            if [ -d "$data_dir" ]; then
                rm -rf "$data_dir"
                echo "数据已清除，将进行全新安装"
            fi
            ;;
        *)
            echo "将保留原有数据在: $data_dir"
            ;;
    esac

    echo
    check_telebox_image  # 检查或构建 TeleBox 镜像
    build_compose_env
    start_compose_interactive
    start_compose_daemon
}

update_telebox_image() {
    echo "正在更新 TeleBox 镜像..."

    # 重新构建镜像
    build_telebox_image
}

view_logs() {
    list_telebox_containers

    while true; do
        printf "请输入要查看日志的 TeleBox 容器名称（仅限字母和数字）[默认: telebox]: "
        read -r container_name <&1

        if [ -z "$container_name" ]; then
            container_name="telebox"
            break
        fi

        if validate_container_name "$container_name"; then
            break
        else
            echo "错误：容器名称只能包含字母和数字，请重新输入"
            echo
        fi
    done

    # 查找 compose 目录
    temp_dir="/tmp/telebox-compose-$container_name"
    if [ ! -f "$temp_dir/docker-compose.yml" ]; then
        # 如果没有 compose 文件，尝试使用 docker 命令
        if docker inspect "$container_name" &>/dev/null; then
            echo "正在查看日志 (按 Ctrl+C 退出)..."
            echo
            docker logs -f "$container_name"
        else
            echo "不存在名为 $container_name 的容器"
            exit 1
        fi
    else
        echo "正在查看日志 (按 Ctrl+C 退出)..."
        echo
        docker_compose_wrapper -f "$temp_dir/docker-compose.yml" logs -f
    fi

    show_menu
}

enter_container() {
    list_telebox_containers

    while true; do
        printf "请输入要进入的 TeleBox 容器名称（仅限字母和数字）[默认: telebox]: "
        read -r container_name <&1

        if [ -z "$container_name" ]; then
            container_name="telebox"
            break
        fi

        if validate_container_name "$container_name"; then
            break
        else
            echo "错误：容器名称只能包含字母和数字，请重新输入"
            echo
        fi
    done

    # 查找 compose 目录
    temp_dir="/tmp/telebox-compose-$container_name"
    if [ ! -f "$temp_dir/docker-compose.yml" ]; then
        # 如果没有 compose 文件，尝试使用 docker 命令
        if docker inspect "$container_name" &>/dev/null; then
            echo "正在进入容器..."
            echo "提示：TeleBox 文件位于 /root/telebox 目录"
            echo "      输入 'exit' 退出容器"
            echo
            docker exec -it "$container_name" bash
        else
            echo "不存在名为 $container_name 的容器"
            exit 1
        fi
    else
        echo "正在进入容器..."
        echo "提示：TeleBox 文件位于 /root/telebox 目录"
        echo "      输入 'exit' 退出容器"
        echo
        docker_compose_wrapper -f "$temp_dir/docker-compose.yml" exec telebox bash
    fi

    show_menu
}

show_container_info() {
    list_telebox_containers

    while true; do
        printf "请输入要查看信息的 TeleBox 容器名称（仅限字母和数字）[默认: telebox]: "
        read -r container_name <&1

        if [ -z "$container_name" ]; then
            container_name="telebox"
            break
        fi

        if validate_container_name "$container_name"; then
            break
        else
            echo "错误：容器名称只能包含字母和数字，请重新输入"
            echo
        fi
    done

    if docker inspect "$container_name" &>/dev/null; then
        echo
        echo "=========================================="
        echo "  容器信息"
        echo "=========================================="
        echo

        # 容器状态
        status=$(docker inspect -f '{{.State.Status}}' "$container_name")
        echo "容器状态: $status"

        # 容器 ID
        container_id=$(docker inspect -f '{{.Id}}' "$container_name" | cut -c1-12)
        echo "容器 ID: $container_id"

        # 镜像信息
        image=$(docker inspect -f '{{.Config.Image}}' "$container_name")
        echo "镜像: $image"

        # 数据目录
        data_dir="/root/Docker_Telebox/$container_name"
        echo "数据目录: $data_dir"

        # 查找 compose 目录
        temp_dir="/tmp/telebox-compose-$container_name"
        if [ -f "$temp_dir/docker-compose.yml" ]; then
            echo "Compose 文件: $temp_dir/docker-compose.yml"
        fi

        # TeleBox 文件位置
        echo "TeleBox 目录:"
        echo "  - 宿主机: $data_dir/telebox"
        echo "  - 容器内: /root/telebox"

        echo
        echo "=========================================="
        echo "  数据目录信息"
        echo "=========================================="
        echo

        if [ -d "$data_dir" ]; then
            echo "目录大小: $(du -sh $data_dir 2>/dev/null | cut -f1)"
            echo
            echo "目录内容:"
            ls -lh "$data_dir" 2>/dev/null || echo "无法访问目录"
        else
            echo "数据目录不存在"
        fi

        echo
        echo "=========================================="
        echo "  TeleBox 文件结构"
        echo "=========================================="
        echo

        if [ -d "$data_dir/telebox" ]; then
            echo "宿主机路径: $data_dir/telebox"
            ls -la "$data_dir/telebox" 2>/dev/null | head -20
        else
            echo "TeleBox 目录不存在"
        fi

        echo
        echo "=========================================="
        echo "  访问文件的方法"
        echo "=========================================="
        echo
        echo "方法 1: 直接在宿主机访问（推荐）"
        echo "  cd $data_dir/telebox"
        echo "  nano config.json"
        echo
        echo "方法 2: 进入容器"
        echo "  docker_compose_wrapper -f $temp_dir/docker-compose.yml exec telebox bash"
        echo "  cd /root/telebox"
        echo

    else
        echo "不存在名为 $container_name 的容器"
        exit 1
    fi

    show_menu
}

backup_telebox() {
    list_telebox_containers

    while true; do
        printf "请输入要备份的 TeleBox 容器名称（仅限字母和数字）[默认: telebox]: "
        read -r container_name <&1

        if [ -z "$container_name" ]; then
            container_name="telebox"
            break
        fi

        if validate_container_name "$container_name"; then
            break
        else
            echo "错误：容器名称只能包含字母和数字，请重新输入"
            echo
        fi
    done

    data_dir="/root/Docker_Telebox/$container_name"

    if [ ! -d "$data_dir" ]; then
        echo "数据目录不存在: $data_dir"
        exit 1
    fi

    backup_file="telebox-backup-$container_name-$(date +%Y%m%d-%H%M%S).tar.gz"

    echo "正在备份 TeleBox 数据..."
    echo "数据目录: $data_dir"
    echo "备份文件: $backup_file"
    echo

    # 直接打包宿主机目录
    tar czf "$backup_file" -C /root/Docker_Telebox "$container_name"

    echo
    echo "备份完成！"
    echo "备份文件: $(pwd)/$backup_file"
    echo
    echo "恢复方法："
    echo "  tar xzf $backup_file -C /root/Docker_Telebox/"
    echo "  然后重新创建容器"
    echo

    show_menu
}

restore_telebox() {
    list_telebox_containers

    while true; do
        printf "请输入要恢复的 TeleBox 容器名称（仅限字母和数字）[默认: telebox]: "
        read -r container_name <&1

        if [ -z "$container_name" ]; then
            container_name="telebox"
            break
        fi

        if validate_container_name "$container_name"; then
            break
        else
            echo "错误：容器名称只能包含字母和数字，请重新输入"
            echo
        fi
    done

    printf "请输入备份文件路径: "
    read -r backup_file <&1

    if [ ! -f "$backup_file" ]; then
        echo "备份文件不存在: $backup_file"
        exit 1
    fi

    echo "正在恢复 TeleBox 数据..."
    echo

    # 停止容器（如果正在运行）
    temp_dir="/tmp/telebox-compose-$container_name"
    if [ -f "$temp_dir/docker-compose.yml" ]; then
        docker_compose_wrapper -f "$temp_dir/docker-compose.yml" down > /dev/null 2>&1
        echo "容器已停止"
    elif docker inspect "$container_name" &>/dev/null; then
        docker stop "$container_name" 2>/dev/null
        echo "容器已停止"
    fi

    # 解压到目标目录
    tar xzf "$backup_file" -C /root/Docker_Telebox/

    echo "数据已恢复到: /root/Docker_Telebox/$container_name"

    # 重新启动容器（如果存在 compose 文件）
    if [ -f "$temp_dir/docker-compose.yml" ]; then
        docker_compose_wrapper -f "$temp_dir/docker-compose.yml" up -d > /dev/null 2>&1
        echo "容器已重启"
    else
        echo "请使用菜单选项 1 创建新容器"
    fi

    echo
    echo "恢复完成！"
    echo

    show_menu
}

show_menu() {
    echo
    echo "=========================================="
    echo "  TeleBox Docker Compose 一键管理脚本"
    echo "=========================================="
    echo
    echo "请选择您需要进行的操作:"
    echo "  1) 安装 TeleBox"
    echo "  2) 卸载 TeleBox"
    echo "  3) 关闭 TeleBox"
    echo "  4) 启动 TeleBox"
    echo "  5) 重启 TeleBox"
    echo "  6) 重装 TeleBox"
    echo "  7) 查看日志"
    echo "  8) 进入容器"
    echo "  9) 查看容器信息"
    echo "  10) 备份 TeleBox"
    echo "  11) 恢复 TeleBox"
    echo "  12) 更新 TeleBox 镜像"
    echo "  0) 退出脚本"
    echo
    echo "  版本: 2.2.2"
    echo "  项目地址: https://github.com/Seikolove/TeleBox"
    echo
    echo -n "请输入编号: "
    read -r choice <&1

    case $choice in
        1)
            start_installation
            ;;
        2)
            cleanup
            ;;
        3)
            stop_telebox
            ;;
        4)
            start_telebox
            ;;
        5)
            restart_telebox
            ;;
        6)
            reinstall_telebox
            ;;
        7)
            view_logs
            ;;
        8)
            enter_container
            ;;
        9)
            show_container_info
            ;;
        10)
            backup_telebox
            ;;
        11)
            restore_telebox
            ;;
        12)
            update_telebox_image
            show_menu
            ;;
        0)
            echo "感谢使用，再见！"
            # 清理临时文件
            find /tmp -name "telebox-compose-*" -type d -exec rm -rf {} + 2>/dev/null
            exit 0
            ;;
        *)
            echo "输入错误，请重新选择"
            sleep 2
            show_menu
            ;;
    esac
}

# 主程序入口
show_menu
